name: Build and Release Executables

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0, v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        default: '0.1.0'
      create_release:
        description: 'Create GitHub release?'
        required: true
        type: boolean
        default: true

jobs:
  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller adipose.spec --clean

      - name: Rename executable for release
        run: |
          mv dist/adipose dist/adipose-linux-x86_64

      - name: Test executable
        run: |
          chmod +x dist/adipose-linux-x86_64
          ./dist/adipose-linux-x86_64 --version
          ./dist/adipose-linux-x86_64 list-platforms

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: adipose-linux-x86_64
          path: dist/adipose-linux-x86_64
          retention-days: 90

  build-macos-intel:
    name: Build macOS Intel Executable
    runs-on: macos-13  # Intel-based runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller adipose.spec --clean

      - name: Rename executable for release
        run: |
          mv dist/adipose dist/adipose-macos-x86_64

      - name: Sign executable (if certificates available)
        if: false  # Enable if you have signing certificates
        run: |
          codesign --force --deep --sign - dist/adipose-macos-x86_64

      - name: Test executable
        run: |
          chmod +x dist/adipose-macos-x86_64
          ./dist/adipose-macos-x86_64 --version
          ./dist/adipose-macos-x86_64 list-platforms

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: adipose-macos-intel
          path: dist/adipose-macos-x86_64
          retention-days: 90

  build-macos-arm:
    name: Build macOS ARM (Apple Silicon) Executable
    runs-on: macos-14  # ARM-based runner (M1/M2)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller adipose.spec --clean

      - name: Rename executable for release
        run: |
          mv dist/adipose dist/adipose-macos-arm64

      - name: Sign executable (if certificates available)
        if: false  # Enable if you have signing certificates
        run: |
          codesign --force --deep --sign - dist/adipose-macos-arm64

      - name: Test executable
        run: |
          chmod +x dist/adipose-macos-arm64
          ./dist/adipose-macos-arm64 --version
          ./dist/adipose-macos-arm64 list-platforms

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: adipose-macos-arm64
          path: dist/adipose-macos-arm64
          retention-days: 90

  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller adipose.spec --clean

      - name: Rename executable for release
        run: |
          mv dist/adipose.exe dist/adipose-windows-x86_64.exe

      - name: Test executable
        run: |
          .\dist\adipose-windows-x86_64.exe --version
          .\dist\adipose-windows-x86_64.exe list-platforms

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: adipose-windows-x86_64
          path: dist/adipose-windows-x86_64.exe
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-macos-intel, build-macos-arm, build-windows]
    runs-on: ubuntu-latest
    # Run if: pushed a tag OR manually triggered with create_release=true
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set release version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag_name=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          # Find all executables and generate checksums
          find . -type f -executable -o -name "*.exe" | while read file; do
            sha256sum "$file" >> SHA256SUMS.txt
            md5sum "$file" >> MD5SUMS.txt
          done
          echo "SHA256 Checksums:"
          cat SHA256SUMS.txt
          echo ""
          echo "MD5 Checksums:"
          cat MD5SUMS.txt

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## Adipose ${{ steps.version.outputs.version }}
          
          **Generate production-ready backend and frontend API layers from a single config!**
          
          ### ðŸŽ‰ What's New
          
          - Standalone executables for Linux, macOS, and Windows
          - No Python installation required
          - Single-file executables (~14-16MB each)
          - Complete Django backend generator
          - 5 backend + 5 frontend frameworks supported
          
          ### ðŸ“¦ Downloads
          
          Download the executable for your platform:
          
          - **Linux (x86_64)**: `adipose-linux-x86_64`
          - **macOS Intel (x86_64)**: `adipose-macos-x86_64`
          - **macOS ARM (M1/M2/M3)**: `adipose-macos-arm64`
          - **Windows (x86_64)**: `adipose-windows-x86_64.exe`
          
          ### ðŸš€ Quick Start
          
          **Linux/macOS:**
          ```bash
          # Download the executable (replace URL with actual release URL)
          # For Linux:
          curl -L -o adipose https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/adipose-linux-x86_64
          
          # For macOS Intel:
          curl -L -o adipose https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/adipose-macos-x86_64
          
          # For macOS ARM:
          curl -L -o adipose https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/adipose-macos-arm64
          
          # Make executable
          chmod +x adipose
          
          # Run
          ./adipose --version
          ./adipose init --output my-api.yaml
          ./adipose generate --config my-api.yaml --backend django --output ./backend
          ```
          
          **Windows (PowerShell):**
          ```powershell
          # Download
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/adipose-windows-x86_64.exe" -OutFile adipose.exe
          
          # Run
          .\adipose.exe --version
          .\adipose.exe init --output my-api.yaml
          .\adipose.exe generate --config my-api.yaml --backend django --output .\backend
          ```
          
          ### âœ¨ Features
          
          - **5 Backend Frameworks**: Django, Express.js, .NET, Spring Boot, Laravel
          - **5 Frontend Frameworks**: JavaScript/TypeScript, Flutter, Swift, Kotlin, AvaloniaUI
          - **JWT Authentication**: Built-in secure authentication
          - **Validation**: Field-level validation and constraints
          - **Pagination**: Configurable pagination
          - **Filtering & Sorting**: Query parameters support
          - **CORS**: Cross-origin resource sharing
          - **Error Handling**: Comprehensive error handling
          
          ### ðŸ“š Documentation
          
          - [Complete Documentation](https://github.com/${{ github.repository }}/blob/main/DOCUMENTATION.md)
          - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          - [Build Instructions](https://github.com/${{ github.repository }}/blob/main/BUILD.md)
          
          ### ðŸ”’ Security
          
          Verify your download with the provided checksums:
          - `SHA256SUMS.txt` - SHA256 checksums
          - `MD5SUMS.txt` - MD5 checksums
          
          **Example verification:**
          ```bash
          # Download checksum file
          curl -L -O https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/SHA256SUMS.txt
          
          # Verify (Linux/macOS)
          sha256sum -c SHA256SUMS.txt
          
          # Or manual verification
          sha256sum adipose-linux-x86_64
          # Compare with SHA256SUMS.txt
          ```
          
          ### ðŸ’¡ Example Configuration
          
          ```yaml
          project:
            name: MyAPI
            version: 1.0.0
            base_url: https://api.myapp.com
          
          auth:
            type: jwt
            token_header: Authorization
            token_prefix: Bearer
          
          models:
            User:
              fields:
                id: integer
                username: string
                email: string
              timestamps: true
          
          endpoints:
            - resource: users
              model: User
              operations: [create, read, update, delete, list]
              auth_required: true
          ```
          
          ### ðŸ› Known Issues
          
          - Django templates fully functional
          - Other framework templates in progress (generators complete, templates needed)
          
          ### ðŸ™ Support
          
          - **Issues**: https://github.com/${{ github.repository }}/issues
          - **Discussions**: https://github.com/${{ github.repository }}/discussions
          - **Documentation**: https://github.com/${{ github.repository }}/blob/main/DOCUMENTATION.md
          
          ---
          
          **System Requirements:**
          - **Linux**: glibc 2.27+ (Ubuntu 18.04+, CentOS 8+, Debian 10+, etc.)
          - **macOS**: 10.13+ High Sierra or later (Intel) / 11.0+ Big Sur or later (ARM)
          - **Windows**: Windows 10 or later
          
          **No Python installation required!** These are standalone executables.
          
          ---
          
          ### ðŸ“Š File Sizes
          
          - Linux: ~14MB
          - macOS Intel: ~15MB
          - macOS ARM: ~14MB
          - Windows: ~16MB
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Adipose ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/adipose-linux-x86_64/adipose-linux-x86_64
            artifacts/adipose-macos-intel/adipose-macos-x86_64
            artifacts/adipose-macos-arm64/adipose-macos-arm64
            artifacts/adipose-windows-x86_64/adipose-windows-x86_64.exe
            artifacts/SHA256SUMS.txt
            artifacts/MD5SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload checksums as artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: |
            artifacts/SHA256SUMS.txt
            artifacts/MD5SUMS.txt
          retention-days: 90
